// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const contentDisposition = require('content-disposition');

module.exports = (app, {settings, config}, req, res, next) =>
{
  const id = req.params.id;

  if (!/^[a-zA-Z0-9_-]+$/.test(id))
  {
    return next(app.createError(`Invalid ID.`, 'INPUT', 400));
  }

  settings.findById(`fa.files.${id}`, (err, setting) =>
  {
    if (err)
    {
      return next(err);
    }

    if (!setting || !setting.value)
    {
      return next(app.createError(`File not found.`, 'NOT_FOUND', 404));
    }

    const file = setting.value;

    if (req.query.download !== '1')
    {
      return res.json(setting);
    }

    res.type(file.type);
    res.append('Content-Disposition', contentDisposition(file.name, {
      type: 'inline'
    }));
    res.sendFile(path.join(config.uploadsDest, file.hash));
  });
};
