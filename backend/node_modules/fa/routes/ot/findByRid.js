// Part of <https://miracle.systems/p/walkner-fa> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {FaOt, canAccess}, req, res, next) =>
{
  let noProperty = 'documentNo';

  if (/^POT/.test(req.query.rid))
  {
    noProperty = 'protocolNo';
  }

  FaOt.findOne({[noProperty]: req.query.rid}).select({_id: 1, stage: 1, users: 1}).lean().exec((err, model) =>
  {
    if (err)
    {
      return next(err);
    }

    if (!model)
    {
      return res.sendStatus(404);
    }

    if (!canAccess(FaOt, req.session.user, model))
    {
      return res.sendStatus(403);
    }

    return res.json(model._id);
  });
};
