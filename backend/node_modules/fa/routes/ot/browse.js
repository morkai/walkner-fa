// Part of <https://miracle.systems/p/walkner-fa> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = (app, module, req, res, next) =>
{
  const {
    express,
    FaOt
  } = module;

  FaOt.SEARCH_PROPS.forEach(prop =>
  {
    const text = req.query[prop];

    if (typeof text !== 'string' || !text.length)
    {
      return;
    }

    const searchText = FaOt.prepareSearchText(text);

    if (!searchText.length)
    {
      return;
    }

    req.rql.selector.args.forEach(term =>
    {
      if (term.name === 'eq' && term.args[0] === prop)
      {
        term.name = 'regex';
        term.args = [`${prop}Search`, _.escapeRegExp(searchText)];
      }
    });
  });

  express.crud.browseRoute(app, FaOt, req, res, next);
};
