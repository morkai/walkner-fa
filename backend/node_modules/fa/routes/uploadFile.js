// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const fs = require('fs');

module.exports = (app, module, req, res, next) =>
{
  const {user, settings} = module;

  if (!req.file)
  {
    return next(app.createError('File missing.', 'INPUT', 400));
  }

  const id = req.params.id;

  if (!/^[a-zA-Z0-9_-]+$/.test(id))
  {
    removeFile(req.file.path);

    return next(app.createError(`Invalid ID.`, 'INPUT', 400));
  }

  const file = {
    hash: req.file.filename.replace(/\..*?$/, ''),
    type: req.file.mimetype,
    size: req.file.size,
    name: req.file.originalname
  };

  settings.update(`fa.files.${id}`, file, user.createUserInfo(req.session.user), err =>
  {
    if (err)
    {
      removeFile(req.file.path);

      return next(err);
    }

    res.sendStatus(204);
  });

  function removeFile(filePath)
  {
    fs.unlink(filePath, (err) =>
    {
      if (err)
      {
        module.error(err, `Failed to remove an unused attachment.`, {filePath});
      }
      else
      {
        module.info(`Removed an unused attachment.`, {filePath});
      }
    });
  }
};
