// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');
const _ = require('lodash');

module.exports = (app, {mongoose, User, DICTIONARIES}, req, res, next) =>
{
  step(
    function()
    {
      User
        .find({privileges: 'FA:LT:committee'})
        .select({firstName: 1, lastName: 1, login: 1, privileges: 1})
        .sort({searchName: 1})
        .lean()
        .exec(this.group());

      _.forEach(DICTIONARIES, modelName => mongoose.model(modelName).find().lean().exec(this.group()));
    },
    function(err, dictionaries)
    {
      if (err)
      {
        return next(err);
      }

      const result = {
        committee: dictionaries.shift()
      };

      Object.keys(DICTIONARIES).forEach((dictionaryName, i) =>
      {
        result[dictionaryName] = dictionaries[i];
      });

      res.json(result);
    }
  );
};
