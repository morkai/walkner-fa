// Part of <https://miracle.systems/p/walkner-fa> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module, userData, doc) =>
{
  if (!userData
    || !Array.isArray(userData.privileges)
    || !userData.privileges.length)
  {
    return false;
  }

  const {privileges} = userData;

  if (privileges.includes('SUPER') || privileges.includes('FA:VIEW:ALL'))
  {
    return true;
  }

  const isUser = Array.isArray(doc.users) && doc.users.includes(userData._id);

  if (isUser)
  {
    return true;
  }

  const isAllowed = stage => privileges.includes(`${doc.constructor.PRIVILEGE_PREFIX}:${stage}`);

  if (!isAllowed('VIEW'))
  {
    return false;
  }

  switch (doc.stage)
  {
    case 'protocol': // OT LT
    {
      return false;
    }

    case 'authorize': // OT
    {
      return false;
    }

    case 'document': // OT
    {
      return false;
    }

    case 'verify': // OT LT
    {
      return isAllowed('verify');
    }

    case 'accept': // OT
    {
      return false;
    }

    case 'record': // OT LT
    {
      return isAllowed('record');
    }

    case 'finished': // OT LT
    {
      return false;
    }

    case 'acceptCommittee': // LT
    {
      return false;
    }

    case 'acceptOwner': // LT
    {
      return false;
    }

    case 'acceptFinance': // LT
    {
      return isAllowed('acceptFinance');
    }

    case 'acceptDepartment': // LT
    {
      return isAllowed('acceptDepartment');
    }

    case 'acceptDocument': // LT
    {
      return false;
    }
  }

  return false;
};
