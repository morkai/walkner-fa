// Part of <https://miracle.systems/p/walkner-fa> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (model, props) =>
{
  const userMap = {};
  const stageModified = model.isModified('stageChangedBy');

  if (stageModified)
  {
    Object.keys(model.stageChangedBy).forEach(stage =>
    {
      const userInfo = model.stageChangedBy[stage];

      if (userInfo && userInfo._id)
      {
        userMap[userInfo._id] = 1;
      }
    });
  }

  props.forEach(prop =>
  {
    const value = model[prop];

    if (!value)
    {
      return;
    }

    if (!stageModified && !model.isModified(prop))
    {
      return;
    }

    if (Array.isArray(value))
    {
      value.forEach(userInfo => userMap[userInfo._id] = 1);
    }
    else
    {
      userMap[value._id] = 1;
    }
  });

  const userList = Object.keys(userMap);

  if (userList.length)
  {
    model.users = userList;
  }
};
